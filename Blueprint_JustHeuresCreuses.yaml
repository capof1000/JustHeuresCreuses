blueprint:
  name: JustHeuresCreuses â€“ Temps ON garanti
  description: >
    Version A : garantit un temps de fonctionnement minimum sur 24h pendant les heures creuses,
    puis optimise selon les prÃ©visions solaires. Ne dÃ©pend pas de l'historique d'Ã©nergie.
  domain: automation

  input:
    target_switch:
      name: Ã‰quipement Ã  contrÃ´ler
      selector:
        entity:
          domain:
            - switch
            - input_boolean

    energy_24h_sensor:
      name: Ã‰nergie consommÃ©e sur 24h
      description: >
        Capteur reprÃ©sentant lâ€™Ã©nergie consommÃ©e par lâ€™Ã©quipement sur 24h.
        
        ðŸ‘‰ RecommandÃ© : crÃ©er ce capteur via lâ€™intÃ©gration native Â« Utility Meter Â»
        directement depuis lâ€™interface Home Assistant.
        
        Ã‰tapes :
        - ParamÃ¨tres > Appareils & services > Assistants > Utility Meter
        - Source : capteur dâ€™Ã©nergie cumulatif (kWh)
        - Cycle : Daily
        - Laisser Â« Delta values Â» dÃ©sactivÃ©
        
        Ce capteur correspond Ã  : Ã©nergie_actuelle âˆ’ Ã©nergie_au_dÃ©but_du_jour.
        Il sâ€™agit dâ€™une vue calculÃ©e officielle (pas dâ€™une nouvelle mesure),
        nÃ©cessaire car les blueprints nâ€™ont pas accÃ¨s Ã  lâ€™historique (valeur Ã  H-24).
      selector:
        entity:
          domain: sensor

    debug_mode:
      name: Mode debug
      description: Active la journalisation dÃ©taillÃ©e
      default: false
      selector:
        boolean: {}

trigger:
  - platform: time_pattern
    minutes: "/1"

condition:
  - condition: state
    entity_id: !input heures_creuses_sensor
    state: "on"

variables:
  sw: !input target_switch
  hc: !input heures_creuses_sensor
  counter_minutes: !input minutes_counter
  min_minutes: !input min_minutes
  solar_sensor: !input solar_forecast_sensor
  solar_threshold: !input solar_threshold
  debug: !input debug_mode

  is_on: "{{ is_state(sw, 'on') }}"
  minutes_today: "{{ states(counter_minutes) | int(0) }}"
  solar_forecast: "{{ states(solar_sensor) | float(0) }}"

action:
  # 1. IncrÃ©menter le compteur si l'appareil est ON
  - if:
      - condition: template
        value_template: "{{ is_on }}"
    then:
      - service: counter.increment
        target:
          entity_id: "{{ counter_minutes }}"

  # 2. DÃ©cision ON / OFF
  - choose:
      # PrioritÃ© : temps minimum non atteint
      - conditions:
          - condition: template
            value_template: "{{ minutes_today < min_minutes }}"
        sequence:
          - service: switch.turn_on
            target:
              entity_id: "{{ sw }}"

      # Sinon : logique solaire
      - conditions:
          - condition: template
            value_template: "{{ solar_forecast > solar_threshold }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: "{{ sw }}"
    default:
      - service: switch.turn_on
        target:
          entity_id: "{{ sw }}"

  # 3. Debug
  - if:
      - condition: template
        value_template: "{{ debug }}"
    then:
      - service: system_log.write
        data:
          level: info
          message: >
            [JustHeuresCreuses][A][DEBUG]
            HC={{ states(hc) }} | Switch={{ states(sw) }}
            Minutes={{ minutes_today }} / {{ min_minutes }}
            Solar={{ solar_forecast }} kWh (seuil {{ solar_threshold }})
            Decision={{ 'FORCE ON (quota)' if minutes_today < min_minutes else ('OFF (solaire OK)' if solar_forecast > solar_threshold else 'ON') }}

mode: single
